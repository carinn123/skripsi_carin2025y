<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prediksi Harga Minyak Goreng Indonesia</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; }
    .container { max-width:1200px; margin:0 auto; padding:0 20px; }

    header { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      box-shadow:0 4px 15px rgba(0,0,0,.1); position:sticky; top:0; z-index:1000; }
    nav { display:flex; justify-content:space-between; align-items:center; padding:1rem 0; }
    .logo { font-size:1.5rem; font-weight:bold; color:#667eea; }
    .nav-links { display:flex; list-style:none; gap:2rem; }
    .nav-links a { text-decoration:none; color:#333; font-weight:500; transition:color .3s ease; }
    .nav-links a:hover, .nav-links a.active { color:#667eea; }

    .input-section { background:rgba(255,255,255,.9); backdrop-filter:blur(10px);
      border-radius:15px; padding:2rem; margin:2rem 0; box-shadow:0 8px 25px rgba(0,0,0,.1); }
    .input-row { display:flex; gap:2rem; align-items:end; flex-wrap:wrap; }
    .input-group { flex:1; min-width:200px; }
    .input-group label { display:block; margin-bottom:.5rem; font-weight:600; color:#333; }
    select, input { width:100%; padding:.75rem; border:2px solid #e1e5e9; border-radius:8px; font-size:1rem; transition:all .3s ease; }
    select:focus, input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1); }
    .btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; padding:.75rem 2rem; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:transform .3s ease, box-shadow .3s ease; min-width:120px; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,.3); }

    .content-section { background:rgba(255,255,255,.9); backdrop-filter:blur(10px);
      border-radius:15px; padding:2rem; margin:2rem 0; box-shadow:0 8px 25px rgba(0,0,0,.1); display:none; }
    .content-section.active { display:block; }
    .section-title { font-size:1.8rem; margin-bottom:1.5rem; color:#333; border-bottom:3px solid #667eea; padding-bottom:.5rem; }

    .chart-container { background:#f8f9fa; border-radius:10px; padding:1rem; margin:1rem 0; min-height:320px;
      display:flex; align-items:center; justify-content:center; border:2px dashed #dee2e6; position:relative; }
    #trendChart, #predChart { width:100%; height:320px; }
    .chart-placeholder { position:absolute; color:#6c757d; font-size:1.05rem; text-align:center; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin:2rem 0; }
    .stat-card { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:1.5rem; border-radius:10px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    .stat-value { font-size:2rem; font-weight:bold; margin-bottom:.5rem; }
    .stat-label { font-size:.9rem; opacity:.9; }

    .info-box { background:#e8f4fd; border-left:4px solid #667eea; padding:1rem; margin:1rem 0; border-radius:0 8px 8px 0; }

    /* Map */
    #map { height:520px; border-radius:12px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,.1); margin-top:1rem; }
    .legend { background:white; padding:.5rem .75rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.12); display:inline-flex; gap:12px; align-items:center; margin-top:.75rem;}
    .legend span { display:inline-flex; align-items:center; gap:6px; }
    .legend i { width:14px; height:14px; display:inline-block; border-radius:3px; }

    @media (max-width:768px){ .nav-links{display:none;} .input-row{flex-direction:column; gap:1rem;} .stats-grid{grid-template-columns:1fr;} }
    .loading { display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; margin-left:10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (untuk peta) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <nav>
        <div class="logo">üõ¢Ô∏è PrediksiMinyak.id</div>
        <ul class="nav-links">
          <li><a href="#" class="nav-link active" data-section="beranda">Beranda</a></li>
          <li><a href="#" class="nav-link" data-section="tren">Tinjauan Tren</a></li>
          <li><a href="#" class="nav-link" data-section="prediksi">Prediksi</a></li>
          <li><a href="#" class="nav-link" data-section="evaluasi">Evaluasi</a></li>
        </ul>
      </nav>
    </header>

    <!-- ===================================================== -->
    <!-- BERANDA: filter PULAU + Tampilkan peta choropleth     -->
    <!-- ===================================================== -->
    <div class="content-section active" id="beranda">
      <h2 class="section-title">Selamat Datang di Sistem Prediksi Harga Minyak Goreng</h2>

      <div class="input-section" id="beranda-filter">
        <div class="input-row">
          <div class="input-group">
            <label for="pulau">Pilih Pulau</label>
            <select id="pulau">
              <option value="">-- Pilih Pulau --</option>
              <!-- diisi via /api/islands -->
            </select>
          </div>

          <div class="input-group">
            <label for="b_tahun">Pilih Tahun</label>
            <select id="b_tahun">
              <option value="">-- Pilih Tahun --</option>
              <option value="2020">2020</option><option value="2021">2021</option>
              <option value="2022">2022</option><option value="2023">2023</option>
              <option value="2024">2024</option><option value="2025">2025</option>
            </select>
          </div>

          <div class="input-group">
            <label for="b_bulan">Pilih Bulan (opsional)</label>
            <select id="b_bulan">
              <option value="">‚Äî Semua Bulan ‚Äî</option>
              <option value="1">Januari</option><option value="2">Februari</option>
              <option value="3">Maret</option><option value="4">April</option>
              <option value="5">Mei</option><option value="6">Juni</option>
              <option value="7">Juli</option><option value="8">Agustus</option>
              <option value="9">September</option><option value="10">Oktober</option>
              <option value="11">November</option><option value="12">Desember</option>
            </select>
          </div>

          <div class="input-group">
            <label for="b_minggu">Minggu ke- (opsional)</label>
            <select id="b_minggu" disabled>
              <option value="">‚Äî Semua Minggu ‚Äî</option>
              <option value="1">1</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="input-group">
            <button class="btn" onclick="showMapBeranda()">Tampilkan
              <span class="loading" id="b_loading" style="display:none;"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="info-box">
        <h3>Tentang Sistem</h3>
        <p>Sistem ini menggunakan <strong>Gradient Boosting</strong> untuk memprediksi harga minyak goreng berdasarkan data historis PIHPS. Di bawah ini adalah <strong>peta harga rata-rata per provinsi</strong> dengan kategori warna: <span style="color:#2ecc71;font-weight:600;">Hijau</span> (rendah), <span style="color:#f1c40f;font-weight:600;">Kuning</span> (sedang), <span style="color:#e74c3c;font-weight:600;">Merah</span> (tinggi).</p>
      </div>

      <div id="map"></div>
      <div class="legend">
        <span><i style="background:#2ecc71"></i> Rendah</span>
        <span><i style="background:#f1c40f"></i> Sedang</span>
        <span><i style="background:#e74c3c"></i> Tinggi</span>
      </div>

      <div class="stats-grid" style="margin-top:1.5rem">
        <div class="stat-card"><div class="stat-value" id="statPulau">-</div><div class="stat-label">Pulau</div></div>
        <div class="stat-card"><div class="stat-value" id="statScope">-</div><div class="stat-label">Periode</div></div>
        <div class="stat-card"><div class="stat-value" id="statLast">-</div><div class="stat-label">Last Actual</div></div>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- INPUT GLOBAL (KAB/KOTA) untuk Tinjauan Tren & Prediksi -->
    <!-- ===================================================== -->
    <div class="input-section">
      <div class="input-row">
        <div class="input-group">
          <label for="kabupaten">Pilih Kabupaten/Kota</label>
          <select id="kabupaten">
            <option value="">-- Pilih Kabupaten/Kota --</option>
            <option value="jakarta-pusat">Jakarta Pusat</option>
            <option value="jakarta-selatan">Jakarta Selatan</option>
            <option value="bandung">Bandung</option>
            <option value="surabaya">Surabaya</option>
            <option value="medan">Medan</option>
            <option value="semarang">Semarang</option>
            <option value="makassar">Makassar</option>
            <option value="palembang">Palembang</option>
            <option value="banjarmasin">Banjarmasin</option>
            <option value="pontianak">Pontianak</option>
            <option value="manado">Manado</option>
            <option value="denpasar">Denpasar</option>
            <option value="mataram">Mataram</option>
            <option value="kupang">Kupang</option>
            <option value="ambon">Ambon</option>
            <option value="jayapura">Jayapura</option>
            <option value="biak">Biak</option>
          </select>
        </div>

        <div class="input-group">
          <label for="tahun">Pilih Tahun</label>
          <select id="tahun">
            <option value="">-- Pilih Tahun --</option>
            <option value="2020">2020</option><option value="2021">2021</option>
            <option value="2022">2022</option><option value="2023">2023</option>
            <option value="2024">2024</option><option value="2025">2025</option>
          </select>
        </div>

        <div class="input-group">
          <label for="bulan">Pilih Bulan (opsional)</label>
          <select id="bulan">
            <option value="">‚Äî Semua Bulan (analisis tahunan) ‚Äî</option>
            <option value="1">Januari</option><option value="2">Februari</option>
            <option value="3">Maret</option><option value="4">April</option>
            <option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option>
            <option value="9">September</option><option value="10">Oktober</option>
            <option value="11">November</option><option value="12">Desember</option>
          </select>
        </div>

        <div class="input-group">
          <label for="minggu">Minggu ke- (opsional)</label>
          <select id="minggu" disabled>
            <option value="">‚Äî Semua Minggu (analisis bulanan) ‚Äî</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>

        <div class="input-group">
          <button class="btn" onclick="loadData()">Analisis Data
            <span class="loading" id="loadingSpinner" style="display:none;"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- TINJAUAN TREN -->
    <div class="content-section" id="tren">
      <h2 class="section-title">Tinjauan Tren Harga Minyak Goreng</h2>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
        <div class="chart-placeholder" id="trendPlaceholder">
          üìà Grafik Tren Harga akan ditampilkan di sini<br>
          <small>Silakan pilih kabupaten/kota & tahun, lalu Analisis Data</small>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="hargaMin">-</div><div class="stat-label">Harga Terendah (Rp/L)</div></div>
        <div class="stat-card"><div class="stat-value" id="hargaMax">-</div><div class="stat-label">Harga Tertinggi (Rp/L)</div></div>
        <div class="stat-card"><div class="stat-value" id="hargaRata">-</div><div class="stat-label">Harga Rata-rata (Rp/L)</div></div>
        <div class="stat-card"><div class="stat-value" id="volatilitas">-</div><div class="stat-label">Volatilitas (%)</div></div>
      </div>

      <div class="info-box">
        <h3>Analisis Pola Harga</h3>
        <p id="analisisTren">Pilih data untuk melihat analisis pola harga dan tren.</p>
      </div>
    </div>

    <!-- PREDIKSI -->
    <div class="content-section" id="prediksi">
      <h2 class="section-title">Prediksi Harga Minyak Goreng</h2>

      <div class="input-row" style="margin-bottom: 1rem;">
        <div class="input-group">
          <label for="startDate">Pilih Tanggal Mulai</label>
          <input type="date" id="startDate">
        </div>
        <div class="input-group">
          <label for="endDate">Pilih Tanggal Akhir</label>
          <input type="date" id="endDate">
        </div>
        <div class="input-group">
          <button class="btn" onclick="loadPrediksi()">Lihat Prediksi</button>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="predChart"></canvas>
        <div class="chart-placeholder" id="predPlaceholder">
          üîÆ Pilih kabupaten/kota (di atas), lalu pilih tanggal mulai & akhir, kemudian klik <b>Lihat Prediksi</b>.
        </div>
      </div>
    </div>

    <!-- EVALUASI -->
    <div class="content-section" id="evaluasi">
      <h2 class="section-title">Evaluasi Model & Performance</h2>
      <div class="chart-container">
        <div class="chart-placeholder">üìä Grafik Evaluasi Model akan ditampilkan di sini</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="mseValue">-</div><div class="stat-label">MSE</div></div>
        <div class="stat-card"><div class="stat-value" id="mapeValue">-</div><div class="stat-label">MAPE (%)</div></div>
        <div class="stat-card"><div class="stat-value" id="r2Value">-</div><div class="stat-label">R¬≤ Score</div></div>
        <div class="stat-card"><div class="stat-value" id="performanceGrade">-</div><div class="stat-label">Grade Model</div></div>
      </div>
    </div>
  </div>

<script>
  // ====== NAV antar section ======
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e){
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.getAttribute('data-section')).classList.add('active');
    });
  });

  // ====== Enable/disable "Minggu ke-" (GLOBAL untuk tren) ======
  const bulanSel = document.getElementById('bulan');
  const mingguSel = document.getElementById('minggu');
  bulanSel.addEventListener('change', () => {
    if (bulanSel.value === "") { mingguSel.value = ""; mingguSel.disabled = true; }
    else { mingguSel.disabled = false; }
  });

  // ====== Enable/disable "Minggu ke-" (BERANDA untuk peta) ======
  const b_bulanSel = document.getElementById('b_bulan');
  const b_mingguSel = document.getElementById('b_minggu');
  b_bulanSel.addEventListener('change', () => {
    if (b_bulanSel.value === "") { b_mingguSel.value = ""; b_mingguSel.disabled = true; }
    else { b_mingguSel.disabled = false; }
  });

  // ====== Util umum ======
  const rupiah = n => new Intl.NumberFormat('id-ID').format(n);

  // Normalisasi nama provinsi supaya cocok meski beda ejaan/kapital/spasi
  function normProv(s){
    return (s||"")
      .toString()
      .toLowerCase()
      .replace(/provinsi|propinsi|prov\./g, "") // buang label
      .replace(/\s+/g, "")                      // buang spasi
      .replace(/[^\w]/g, "");                   // buang tanda baca
  }

  // Cache GeoJSON di memori
  let __PROV_GJ = null;
  async function getProvGeoJSON() {
    if (__PROV_GJ) return __PROV_GJ;
    // pastikan file berada di: static/indonesia_provinces.geojson
    const r = await fetch('/indonesia_provinces.geojson?v=1', { cache: 'no-store' });
    if (!r.ok) throw new Error('GeoJSON provinsi tidak ditemukan');
    __PROV_GJ = await r.json();
    return __PROV_GJ;
  }

  // =================== BERANDA: PETA CHOROPLETH ===================
  (async function initIslands(){
    try{
      const res = await fetch('/api/islands');
      const islands = await res.json();
      const sel = document.getElementById('pulau');
      islands.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n;
        sel.appendChild(opt);
      });
    }catch(e){ console.error(e); }
  })();

  let map, geoLayer;
  function ensureMap(){
    if (map) return map;
    map = L.map('map', {scrollWheelZoom:true}).setView([-2.5, 118], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 10, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    return map;
  }
  function colorByCat(cat){
    if (cat==='low') return '#2ecc71';   // hijau
    if (cat==='mid') return '#f1c40f';   // kuning
    return '#e74c3c';                    // merah
  }

  async function showMapBeranda(){
    const island = document.getElementById('pulau').value || 'Semua Pulau';
    const tahun  = document.getElementById('b_tahun').value;
    const bulan  = document.getElementById('b_bulan').value;
    const minggu = document.getElementById('b_minggu').value;
    const loading = document.getElementById('b_loading');

    if(!tahun){ alert('Pilih tahun dulu.'); return; }

    loading.style.display = 'inline-block';
    try{
      const url = `/api/choropleth?island=${encodeURIComponent(island)}&year=${encodeURIComponent(tahun)}&month=${encodeURIComponent(bulan)}&week=${encodeURIComponent(minggu)}`;
      const res = await fetch(url);
      const js  = await res.json();
      if(!res.ok) throw new Error(js.error || 'Server error');

      const m = ensureMap();
      const gj = await getProvGeoJSON();

      // lookup data nilai per provinsi (key sudah dinormalisasi)
      const vmap = Object.fromEntries(
        js.data.map(d => [ normProv(d.province), {val:d.value, cat:d.category, label:d.province} ])
      );

      // hapus layer lama
      if (geoLayer) geoLayer.remove();

      geoLayer = L.geoJSON(gj, {
        style: feature => {
          // ambil nama prov dari berbagai kemungkinan properti
          const rawName = feature.properties.Propinsi
                       || feature.properties.PROVINSI
                       || feature.properties.provinsi
                       || feature.properties.name
                       || feature.properties.NAMOBJ
                       || "";
          const rec  = vmap[normProv(rawName)];
          const fill = rec ? colorByCat(rec.cat) : '#bdc3c7';
          return { color:'#fff', weight:1, fillColor: fill, fillOpacity: 0.8 };
        },
        onEachFeature: (feature, layer) => {
          const rawName = feature.properties.Propinsi
                       || feature.properties.PROVINSI
                       || feature.properties.provinsi
                       || feature.properties.name
                       || feature.properties.NAMOBJ
                       || "‚Äî";
          const rec  = vmap[normProv(rawName)];
          const val  = rec ? Math.round(rec.val) : null;
          const cat  = rec ? rec.cat : 'no-data';
          layer.bindPopup(`<b>${rawName}</b><br/>${val?('Rp ' + rupiah(val)):'‚Äî'}<br/>Kategori: ${cat}`);
        }
      }).addTo(m);

      try { m.fitBounds(geoLayer.getBounds(), {padding:[20,20]}); } catch(e) {}

      // update stat kecil
      document.getElementById('statPulau').textContent = island || 'Semua Pulau';
      let scope = `Tahun ${tahun}`;
      if (bulan) scope = `Bulan ${bulan} ${tahun}`;
      if (bulan && minggu) scope = `Minggu ke-${minggu}, Bulan ${bulan} ${tahun}`;
      document.getElementById('statScope').textContent = scope;
      document.getElementById('statLast').textContent  = js.last_actual || '-';
    }catch(e){
      console.error(e);
      alert('Gagal menampilkan peta: ' + e.message);
    }finally{
      loading.style.display = 'none';
    }
  }

  // =================== TINJAUAN TREN (by city) ===================
  let trendChart = null;

  function renderTrendChart(series, granularity, title){
    const placeholder = document.getElementById('trendPlaceholder');
    const ctx = document.getElementById('trendChart').getContext('2d');

    const labels = series.map(s => s.label);
    const data = series.map(s => s.value);

    if (!series.length){
      placeholder.style.display = 'block';
      if (trendChart){ trendChart.destroy(); trendChart = null; }
      return;
    }
    placeholder.style.display = 'none';

    const datasetLabel =
      granularity === 'yearly'  ? 'Rata-rata per Bulan' :
      granularity === 'monthly' ? 'Rata-rata per Minggu' :
      'Harian (Minggu terpilih)';

    const chartData = {
      labels,
      datasets: [{ label: datasetLabel, data, tension: .25, fill: true, pointRadius: 3 }]
    };

    const options = {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        title:{ display:true, text:title },
        tooltip:{ callbacks:{ label: (ctx)=> ` ${datasetLabel}: Rp ${rupiah(ctx.parsed.y)}` } }
      },
      scales:{
        y:{ ticks:{ callback:(v)=> 'Rp ' + rupiah(v) }, beginAtZero:false },
        x:{ ticks:{ autoSkip:true, maxRotation:0 } }
      }
    };

    if (trendChart){ trendChart.data = chartData; trendChart.options = options; trendChart.update(); }
    else { trendChart = new Chart(ctx, { type:'line', data:chartData, options }); }
  }

  async function loadData(){
    const kabupaten = document.getElementById('kabupaten').value;
    const tahun     = document.getElementById('tahun').value;
    const bulan     = document.getElementById('bulan').value;
    const minggu    = document.getElementById('minggu').value;
    const loading   = document.getElementById('loadingSpinner');

    if(!kabupaten || !tahun){ alert('Silakan pilih kabupaten/kota dan tahun terlebih dahulu!'); return; }

    loading.style.display = 'inline-block';
    try{
      const url = `/api/trend?city=${encodeURIComponent(kabupaten)}&year=${encodeURIComponent(tahun)}&month=${encodeURIComponent(bulan)}&week=${encodeURIComponent(minggu)}`;
      const res = await fetch(url);
      const trend = await res.json();
      if(!res.ok) throw new Error(trend.error || 'Server error');

      const s = trend.stats || {};
      const fmt = n => (n==null||Number.isNaN(n))? "-" : rupiah(Math.round(n));
      document.getElementById('hargaMin').textContent  = fmt(s.min);
      document.getElementById('hargaMax').textContent  = fmt(s.max);
      document.getElementById('hargaRata').textContent = fmt(s.mean);
      document.getElementById('volatilitas').textContent = (s.vol_pct==null? "-" : s.vol_pct.toFixed(2));

      let scope = `Tahun ${tahun}`;
      if (bulan) scope = `Bulan ${bulan} ${tahun}`;
      if (bulan && minggu) scope = `Minggu ke-${minggu}, Bulan ${bulan} ${tahun}`;
      const title = `Tren Harga ‚Ä¢ ${kabupaten.replace('-', ' ').toUpperCase()} ‚Ä¢ ${scope}`;

      renderTrendChart(trend.series || [], trend.granularity, title);

      document.getElementById('analisisTren').textContent =
        `Analisis ${scope}: n=${s.n||0}, rata-rata Rp ${fmt(s.mean)}, rentang Rp ${fmt(s.min)}‚ÄìRp ${fmt(s.max)}, volatilitas ${(s.vol_pct==null? "-" : s.vol_pct.toFixed(2))}%.`;

      document.querySelector('[data-section="tren"]').click();
    }catch(e){
      console.error(e);
      alert('Gagal memuat tren: ' + e.message);
    }finally{
      loading.style.display = 'none';
    }
  }

  // =================== PREDIKSI (by city) ===================
  let predChart = null;

  function ensurePredChart() {
    const ctx = document.getElementById('predChart').getContext('2d');
    if (!predChart) {
      predChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Aktual vs Forecast (Gradient Boosting)' },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (ctx) => ` ${ctx.dataset.label}: Rp ${new Intl.NumberFormat('id-ID').format(Math.round(ctx.parsed.y))}`
              }
            },
            legend: { position: 'top' }
          },
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { ticks: { callback: v => 'Rp ' + new Intl.NumberFormat('id-ID').format(v) } },
            x: { ticks: { autoSkip: true, maxRotation: 0 } }
          }
        }
      });
    }
    return predChart;
  }

  async function loadPrediksi() {
    const city = document.getElementById('kabupaten').value;
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;
    const placeholder = document.getElementById('predPlaceholder');

    if (!city)  { alert('Pilih kabupaten/kota dulu.'); return; }
    if (!start || !end) { alert('Tanggal mulai & akhir wajib diisi.'); return; }

    try {
      const url = `/api/predict_range?city=${encodeURIComponent(city)}&start=${start}&end=${end}`;
      const res = await fetch(url);
      const js = await res.json();
      if (!res.ok) throw new Error(js.error || 'Server error');

      const labelSet = new Set();
      js.actual.forEach(p => labelSet.add(p.date));
      js.predicted.forEach(p => labelSet.add(p.date));
      const labels = Array.from(labelSet).sort();

      const aMap = Object.fromEntries(js.actual.map(p => [p.date, p.value]));
      const pMap = Object.fromEntries(js.predicted.map(p => [p.date, p.value]));

      const actualY  = labels.map(d => aMap[d] ?? null);
      const predictY = labels.map(d => pMap[d] ?? null);

      const chart = ensurePredChart();
      placeholder.style.display = 'none';
      chart.data.labels = labels;
      chart.data.datasets = [
        { label: 'Aktual',   data: actualY,  borderWidth: 2, spanGaps: true, pointRadius: 2 },
        { label: 'Forecast', data: predictY, borderWidth: 2, borderDash: [6,4], spanGaps: true, pointRadius: 2 }
      ];
      chart.update();

      document.querySelector('[data-section="prediksi"]').click();
    } catch (e) {
      console.error(e);
      alert('Gagal memuat prediksi: ' + e.message);
    }
  }
</script>
</body>
</html>
